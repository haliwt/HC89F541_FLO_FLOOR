/**
*   ************************************************************************************
*								ï¿½Ïºï¿½Ð¾Ê¥ï¿½ï¿½ï¿½Ó¹É·ï¿½ï¿½ï¿½ï¿½Þ¹ï¿½Ë¾
*								    www.holychip.cn
*	************************************************************************************
*	@Examle Version		V1.0.0.0
*	@Demo Version		V1.0.1.0
*	@Date				2017.09.18
*	************************************************************************************
*									 Ä£ï¿½ï¿½ï¿½ï¿½ï¿½Ü½ï¿½ï¿½ï¿½
*	1ï¿½ï¿½ï¿½ï¿½ï¿½ë£¨ï¿½ï¿½SMTï¿½ï¿½Ä£Ê½ï¿½ï¿½VDD=5VÊ±ï¿½ï¿½ï¿½Íµï¿½Æ½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½Íµï¿½Ñ¹ï¿½ï¿½VIL1ï¿½ï¿½ï¿½ï¿½Î§Îª0~1.5Vï¿½ï¿½ï¿½ßµï¿½Æ½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½
*	   ï¿½ßµï¿½Ñ¹ï¿½ï¿½VIH1ï¿½ï¿½ï¿½ï¿½Î§Îª3.5~5Vï¿½ï¿½
*	2ï¿½ï¿½ï¿½ï¿½ï¿½ë£¨SMTï¿½ï¿½Ä£Ê½ï¿½ï¿½VDD=5VÊ±ï¿½ï¿½ï¿½Íµï¿½Æ½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½Íµï¿½Ñ¹ï¿½ï¿½VIL1ï¿½ï¿½ï¿½ï¿½Î§Îª0~1Vï¿½ï¿½ï¿½ßµï¿½Æ½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ßµï¿?
*	   Ñ¹ï¿½ï¿½VIH1ï¿½ï¿½ï¿½ï¿½Î§Îª4~5Vï¿½ï¿½
*	3ï¿½ï¿½P0xDBCT [5:0]ï¿½ï¿½ï¿½Ãµï¿½ï¿½ï¿½ï¿½ï¿½Ê±ï¿½ï¿½ï¿½ï¿½Ò»ï¿½ï¿½ï¿½ï¿½Î§ï¿½ï¿½ï¿½ï¿½ÆµÏµï¿½ï¿½*Tosc*P0xDBCT[5:0]-Tosc<ï¿½ï¿½ï¿½ï¿½Ê±ï¿½ï¿½<
*	   ï¿½ï¿½ÆµÏµï¿½ï¿½*Tosc*(P0xDBCT[5:0]+1)-Toscï¿½ï¿½
	4ï¿½ï¿½HC89F003ï¿½Ïµç¸´Î»ï¿½Ô¼ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½Î»ï¿½ï¿½ï¿½ÜµÄ¸ï¿½Î»ï¿½ï¿½ï¿½ï¿½ï¿½Ðµï¿½IOï¿½ï¿½Ø¼Ä´ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½Ö¸ï¿½ÎªÄ¬ï¿½ï¿½Öµï¿½ï¿½
*	************************************************************************************
*									 Ó¦ï¿½ï¿½×¢ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½
*	1ï¿½ï¿½ï¿½ï¿½Ê¹ï¿½Ã·ï¿½ï¿½ï¿½ï¿½ï¿½Ê±ï¿½ï¿½ï¿½ï¿½JTAGï¿½ï¿½ï¿½Ãµï¿½IOï¿½Ú»ï¿½ï¿½Ð¶ï¿½È¡ï¿½ï¿½Ð´ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ì³£ï¿½ï¿½ï¿½ï¿½Ë½ï¿½ï¿½ï¿½Ê¹ï¿½Ã·ï¿½ï¿½ï¿½ï¿½ï¿½Ê±ï¿½ï¿½Ò?
*	   ï¿½ï¿½ï¿½ï¿½ï¿½â¼¸ï¿½ï¿½IOï¿½Ú¡ï¿½ï¿½Ï¿ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½Ê¹ï¿½Ãµï¿½Ô´ï¿½ï¿½ï¿½ç¼´ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½
*	2ï¿½ï¿½ï¿½ï¿½ï¿½äµ½P0.0/P0.1/P0.2ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½Ü½ï¿½ï¿½ÏµÄ¹ï¿½ï¿½Ü½Å¡ï¿½ï¿½â²¿ï¿½Ð¶ï¿½ï¿½ï¿½ï¿½ë¡¢ï¿½ï¿½ï¿½Ï¼ï¿½ï¿½ï¿½ï¿½ï¿½Å¶ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½Æ¡ï¿?
*   3ï¿½ï¿½HC89F003ï¿½ï¿½Bï¿½æ¼°ï¿½ï¿½ï¿½Ôºï¿½æ±¾ï¿½ï¿½IOï¿½ï¿½P23ï¿½ï¿½P24ï¿½ï¿½P25ï¿½ï¿½P27ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½Í¬Ê±Ê¹ï¿½ÜµÄ¹ï¿½ï¿½Ü£ï¿½
       ï¿½ï¿½ï¿½Ç²ï¿½ï¿½ï¿½ï¿½ï¿½Ê¹ï¿½Ã´ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½Ô¼ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ë£¬ï¿½ï¿½ï¿½Ç¿ï¿½ï¿½ï¿½Ê¹ï¿½Ã´ï¿½Ê©ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½Ô¼ï¿½ï¿½ï¿½Ê©ï¿½ï¿½ï¿½ï¿½
       ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ë£¬ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½DateSheetï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½Ð¾Æ¬ï¿½æ±¾ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½Ñ¯ï¿½Ê´ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½Ô¼ï¿½Ô­ï¿½ï¿½Òµï¿½ï¿?
*	************************************************************************************
*  								       ï¿½Í»ï¿½ï¿½ï¿½ï¿½ï¿½
*	ï¿½ï¿½Ð»ï¿½ï¿½Ê¹ï¿½ï¿½ï¿½ï¿½ï¿½ÇµÄµï¿½Æ¬ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½Ö´ï¿½ï¿½ï¿½ï¿½Ôºï¿½ï¿½ï¿½ï¿½ï¿½Ê¹ï¿½Ã´ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½Ê¡ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½Ïºï¿½Ð¾Ê¥ï¿½ï¿½ï¿½Ó¹Ù·ï¿½QQÈº
*	****************************ï¿½ï¿½ï¿½ï¿½Ö§ï¿½ï¿½Èºï¿½ï¿½201030494***********************************
*   ************************************************************************************
**/
#define	ALLOCATE_EXTERN
#define	ver 5

#include "HC89F0541.h"

#include "..\lib\LB_Led.h"
#include "..\lib\LB_AD.h"
#include "..\lib\LB_Usart.h"
#include "..\lib\LB_eeprom.h"
#include "..\lib\LB_Motor.h"
#include "..\lib\LB_IR.h"
#include "..\lib\LB_Run.h"

void InitSysclk(INT8U SYS)
{

	/************************************ÏµÍ³ï¿½ï¿½Ê¼ï¿½ï¿½****************************************/
	WDTCCR = 0x00;						//ï¿½Ø±Õ¿ï¿½ï¿½Å¹ï¿½

	while((CLKCON&0x20)!=0x20);			//ï¿½È´ï¿½ï¿½Ú²ï¿½ï¿½ï¿½Æµï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½
	CLKSWR = 0x51;						//Ñ¡ï¿½ï¿½ï¿½Ú²ï¿½ï¿½ï¿½ÆµÊ±ï¿½ï¿½Îªï¿½ï¿½Ê±ï¿½Ó£ï¿½ï¿½Ú²ï¿½ï¿½ï¿½ÆµRC2ï¿½ï¿½Æµï¿½ï¿½Fosc=16MHz
	while((CLKSWR&0xC0)!=0x40);			//ï¿½È´ï¿½ï¿½Ú²ï¿½ï¿½ï¿½Æµï¿½Ð»ï¿½ï¿½ï¿½ï¿?
	CLKDIV = SYS;						//Fosc1ï¿½ï¿½Æµï¿½Ãµï¿½Fcpuï¿½ï¿½Fcpu=16MHz
}



/***************************************************************************************
  * @Êµï¿½ï¿½Ð§ï¿½ï¿½	ï¿½ï¿½P02ï¿½Ë¿Úµï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½Îª100K
***************************************************************************************/
void main(void)
{

	INT8U kk;
	INT8U  abc;
	InitSysclk(1);

	InitT1();
	InitADIO();
	Init_MotorSpeed();
    InitMotorIO();
	Init_Usart1();
	InitFanEdgeIO(); //
	InitLed();
	InitKey();
	InitPowerIn();
	InitPowerStatus();

	ADCtl=1;
	LedBlueON();
	RunMode=0;  //ï¿½ï¿½ï¿½ï¿½Ä£Ê½
	RunStep=0;
	RunSecond=0;
	LCurrent=0;
	RCurrent=0;
	
    Mode=1;
    Step=0;
	abc=0;
	
while(1)
	{

	  // CheckGround();
	   CheckRun();
	   kk=ReadKey();
	   if(kk==0){
	    // kk=CheckHandsetIR();
	   }
       CheckMode(kk);
	  
	  }

}
/***********************************************************
	**
	*ï¿½Ð¶Ï³ï¿½ï¿½ï¿½:Ã¿0.1ms ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½Ð¶ï¿½Ò»ï¿½ï¿½
	*
	**
***********************************************************/
void TIMER1_Rpt(void) interrupt TIMER1_VECTOR
{
  static INT8U idata t_10ms;
  static INT8U idata t_100ms;
  static INT8U idata t_1s;
  t_10ms++;
  ReadAD5ms();//ï¿½ï¿½ï¿½IR ï¿½Ï°ï¿½ï¿½ï¿½

  if(t_10ms>99) //10ms
  {
  	t_10ms=0;
	t_100ms++;
	t_1s++;
	RunMs++;
 	 CheckLeftMotorSpeed(); //ï¿½ï¿½ï¿½ï¿½Ò»ï¿½ï¿½ï¿½Ù¶ï¿½
	 CheckRightMotorSpeed(); //
	 AdjustSpeed(); //ï¿½ï¿½ï¿½ï¿½ï¿½Ù¶ï¿½
	if(t_100ms>9)//10 *10ms =100ms
	{
	  if(ReadPowerStatus()) //P1_7 ==1 OK ï¿½ï¿½Ø¹ï¿½ï¿½ï¿½Ð¾Æ¬ï¿½ï¿?
	    PowerCountOK++;
	  t_100ms=0;
	  CheckLCurrent();
	  CheckRCurrent();
	  NoImpSecond++;
	}
	
	CheckEdgeCurrent();
	CheckVoltage();
	if(t_1s>99) //100 * 10ms = 1000ms =1s
	{
	  t_1s=0;
	  PumpTime++;
      PowerSavingTime++ ;
	   RunSecond++;
	  ///*
	  #if 0
	  Usart1Send[0]=15; //printf 15 number output
	  Usart1Send[1]=0x0A;//Voltage/100;
	  Usart1Send[2]=0x0B;//Voltage%100;
	  Usart1Send[3]=GroundDp[0];
	  Usart1Send[4]=GroundDp[1];
	  Usart1Send[5]=GroundDp[2];
	  Usart1Send[6]=LCurrent/10;
	  Usart1Send[7]=RCurrent/10;

	  Usart1Send[8]=LeftMoveMotorData.AvgSpeed;
	  Usart1Send[9]=RightMoveMotorData.AvgSpeed;
	  Usart1Send[10]=LeftMoveMotorData.OutPWM;
	  Usart1Send[11]=RightMoveMotorData.OutPWM;
	  Usart1Send[12]=RunMode;
	  Usart1Send[13]=RunStep;
	  Usart1Send[14]=Mode;
	  Usart1Send[15]=Step;
	  SendCount=1;
	  SBUF=Usart1Send[SendCount];
	  #endif 
	 //*/
	  /*
	  Usart1Send[0]=13;
	  Usart1Send[1]=LeftIR.Left;
	  Usart1Send[2]=LeftIR.Right;
	  Usart1Send[3]=LeftIR.Mid;
	  Usart1Send[4]=LeftIR.Top;

	  Usart1Send[5]=MidIR.Left;
	  Usart1Send[6]=MidIR.Right;
	  Usart1Send[7]=MidIR.Mid;
	  Usart1Send[8]=MidIR.Top;

	  Usart1Send[9]=RightIR.Left;
	  Usart1Send[10]=RightIR.Right;
	  Usart1Send[11]=RightIR.Mid;
	  Usart1Send[12]=RightIR.Top;

	  Usart1Send[13]=RunStep;
	  SendCount=1;
	  SBUF=Usart1Send[SendCount];
  	  */
	  //SBUF=Usart1Send[SendCount];	
	}
  }
}
void WDT_Rpt() interrupt WDT_VECTOR
{
	WDTC &=~ 0x20;						//ï¿½ï¿½ï¿½WDTï¿½Ð¶Ï±ï¿½Ö¾Î»
}
/***************************************************************************************
  * @Ëµï¿½ï¿½  	INT8-17ï¿½Ð¶Ï·ï¿½ï¿½ï¿½ï¿½ï¿½
  *	@ï¿½ï¿½ï¿½ï¿½	ï¿½ï¿½
  * @ï¿½ï¿½ï¿½ï¿½Öµ ï¿½ï¿½
  * @×¢		ï¿½ï¿½
***************************************************************************************/
void INT8_17_Rpt() interrupt INT8_17_VECTOR 
{
   if(PINTF2&0x01)						//ï¿½Ð¶ï¿½INT16ï¿½Ð¶Ï±ï¿½Ö¾Î»----L MOTOR SPEED
	{
	 // LmotorSpeedNum ++ ;
	  PINTF2 &=0XFE;				//ï¿½ï¿½ï¿½INT16ï¿½Ð¶Ï±ï¿½Ö¾Î»	--motor L speed ï¿½ï¿½ï¿?
	  ReadLeftPulsed();
	  
	}
	else if(PINTF2&0x02)			//ï¿½Ð¶ï¿½INT17ï¿½Ð¶Ï±ï¿½Ö¾Î» -----R motor SPEED
	{
	  RmotorSpeedNum ++ ;
	  PINTF2 &=0XFD;				//ï¿½ï¿½ï¿½INT17ï¿½Ð¶Ï±ï¿½Ö¾Î»	--ï¿½ï¿½ï¿½ï¿½ R speed ï¿½ï¿½ï¿?
	  ReadRightPulsed();
	  
	}
	else if(PINTF1&0x80)			 //P1_7 GPIO INT15 interrupt number #15 -CHARGE_SATA
	{
	  PINTF1 &=0X7f;				//ï¿½ï¿½ï¿½INT15ï¿½Ð¶Ï±ï¿½Ö¾Î»---ï¿½ï¿½Ø³ï¿½ï¿½×´Ì¬Öµ		
	  PowerCountErr++;
	  PowerCountOK=0;
	}
	else if(PINTF1&0x20)						//ÅÐ¶ÏINT13ÖÐ¶Ï±êÖ¾Î»
	{
		PINTF1 &=~ 0x20;				//Çå³ýINT13ÖÐ¶Ï±êÖ¾Î»	
		Read_LeftIR();
	}
	else
    {
	  //PINTF1 =0;
	  //PINTF2 =0;
	}
	

}